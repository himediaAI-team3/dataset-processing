import pandas as pd
import json
import time
import os
from datetime import datetime
from anthropic import Anthropic
from typing import Dict, List, Optional
import re

class CosmeticDataGenerator:
    def __init__(self, api_key: str):
        """
        í™”ì¥í’ˆ ë°ì´í„° ìƒì„±ê¸° ì´ˆê¸°í™”
        
        Args:
            api_key: Claude API í‚¤
        """
        self.client = Anthropic(api_key=api_key)
        self.model = "claude-sonnet-4-20250514"
        
        # í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
        self.prompt_template = """
ë‹¹ì‹ ì€ í”¼ë¶€ê³¼ ì „ë¬¸ í™”ì¥í’ˆ ë°ì´í„° ë¶„ì„ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ í™”ì¥í’ˆì˜ ì œí’ˆì„¤ëª…ì„ ì°¸ê³ í•˜ê³  ì „ì„±ë¶„ì„ ë¶„ì„í•˜ì—¬ í”¼ë¶€ì§ˆí™˜ ì¼€ì–´ì— ì í•©í•œ êµ¬ì¡°í™”ëœ ìƒì„¸ì •ë³´ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

## ì…ë ¥ ì •ë³´
- ì œí’ˆëª…: {ì œí’ˆëª…}
- ë¸Œëœë“œ: {ë¸Œëœë“œ}
- ì œí’ˆì„¤ëª…: {ì œí’ˆì„¤ëª…}
- ì „ì„±ë¶„: {ì „ì„±ë¶„}  # â† ì „ì²´ ë‹¤ ë„£ê¸°!

## ë¶„ì„ ë°©ë²•
0. í™”ì¥í’ˆ íšŒì‚¬ì—ì„œ ì œê³µí•˜ëŠ” ì œí’ˆì„¤ëª…ì„ ì½ê³  ì œí’ˆì˜ ì£¼ ëª©ì ì„ íŒŒì•…í•˜ì„¸ìš”.
1. ì „ì„±ë¶„ ë¦¬ìŠ¤íŠ¸ë¥¼ ë³´ê³  íš¨ëŠ¥ì´ ìˆëŠ” í•µì‹¬ ì„±ë¶„ì„ ì‹ë³„í•˜ì„¸ìš”
2. ì„±ë¶„ì˜ ë†ë„ëŠ” ë¦¬ìŠ¤íŠ¸ ì•ìª½ì— ìˆì„ìˆ˜ë¡ ë†’ìŠµë‹ˆë‹¤
3. ë‹¤ìŒ ì„±ë¶„ë“¤ì— íŠ¹íˆ ì£¼ëª©í•˜ì„¸ìš”:
   - í”¼ë¶€ì¥ë²½: ì„¸ë¼ë§ˆì´ë“œ, ì½œë ˆìŠ¤í…Œë¡¤, í”¼í† ìŠ¤í•‘ê³ ì‹ 
   - ë³´ìŠµ: íˆì•Œë£¨ë¡ ì‚°, ê¸€ë¦¬ì„¸ë¦°, íŒí…Œë†€, ë² íƒ€ê¸€ë£¨ì¹¸
   - ì§„ì •: ì•Œë€í† ì¸, ì„¼í…”ë¼, ë§ˆë°ì¹´ì†Œì‚¬ì´ë“œ, ë¹„ì‚¬ë³´ë¡¤
   - í•­ì—¼: ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ, ì§•í¬í”¼ë¦¬ì¹˜ì˜¨, ì•„ì ¤ë¼ì‚°
   - ê°ì§ˆì œê±°: ì‚´ë¦¬ì‹¤ì‚°, AHA, BHA, LHA
   - í”¼ì§€ì¡°ì ˆ: ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ, ì§•í¬ PCA

## ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ì„ ì •í™•íˆ ë”°ë¥¼ ê²ƒ)
[ì œí’ˆìœ í˜•: ìœ í˜•]
[í”¼ë¶€íƒ€ì…: íƒ€ì…1, íƒ€ì…2]
[ê´€ë ¨ í”¼ë¶€ì§ˆí™˜: ì§ˆí™˜1, ì§ˆí™˜2]
[ì£¼ìš” íš¨ëŠ¥: íš¨ëŠ¥1, íš¨ëŠ¥2]
[ì¼€ì–´ ì¦ìƒ: ì¦ìƒ1, ì¦ìƒ2]
[í•µì‹¬ ì„±ë¶„: ì„±ë¶„1, ì„±ë¶„2]

ì œí’ˆì´ ì–´ë–¤ í”¼ë¶€ì§ˆí™˜/ì¦ìƒì— ì–´ë–»ê²Œ ë„ì›€ë˜ëŠ”ì§€ 2-3ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª….

## ì‘ì„± ê·œì¹™

### 0. ì œí’ˆìœ í˜• 
- ì œí’ˆëª…ì—ì„œ ì œí’ˆ ìœ í˜•ì„ íŒŒì•…í•˜ì„¸ìš” (í¬ë¦¼, ë¡œì…˜, ì„¸ëŸ¼, í† ë„ˆ, í´ë Œì €, ì„ í¬ë¦¼ ë“±)

### 1. í”¼ë¶€íƒ€ì… (1-2ê°œ ì„ íƒ)
- ì„ íƒì§€: ì§€ì„±, ê±´ì„±, ë³µí•©ì„±, ë¯¼ê°ì„±
- ì „ì„±ë¶„ì˜ íŠ¹ì„±ì„ ê³ ë ¤í•˜ì—¬ íŒë‹¨

### 2. ê´€ë ¨ í”¼ë¶€ì§ˆí™˜ (1-3ê°œ ì„ íƒ) â­ ë§¤ìš° ì¤‘ìš”
- ì„ íƒì§€: ê±´ì„  / ì•„í† í”¼ / ì—¬ë“œë¦„ / ì£¼ì‚¬ / ì§€ë£¨ / ì •ìƒ
- ê¸°ë³¸ê°’: "ì •ìƒ" (í™•ì‹¤í•˜ì§€ ì•Šìœ¼ë©´ ì •ìƒìœ¼ë¡œ)
- ë‹¤ìŒ ì„±ë¶„ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì•„í† í”¼/ê±´ì„  ì œì™¸: ë ˆí‹°ë†€, ë ˆí‹°ë‚ , ë ˆí‹°ë…¸ì´ë“œ, ë¹„íƒ€ë¯¼C (Ascorbic Acid) 5% ì´ìƒ, AHA (ê¸€ë¦¬ì½œì‚°, ë½í‹±ì‚° ë“±) 5% ì´ìƒ, í–¥ë£Œ, ë³€ì„± ì•Œì½”ì˜¬, ê°•í•œ ê³„ë©´í™œì„±ì œ (SLS, SLES)
- ê±´ì„ ì´ë‚˜ ì•„í† í”¼ ì„ íƒì‹œ ê³ ë ¤í•  ê²ƒ: ì„¸ë¼ë§ˆì´ë“œ + ì½œë ˆìŠ¤í…Œë¡¤ ì¡°í•© OR ì„¸ë¼ë§ˆì´ë“œ 2ì¢… ì´ìƒ, ìê·¹ ì„±ë¶„ ì „í˜€ ì—†ìŒ

### 3. ì£¼ìš” íš¨ëŠ¥ (2-4ê°œ)
- ì˜ˆì‹œ: ë³´ìŠµ, ì§„ì •, í”¼ë¶€ì¥ë²½ê°•í™”, í”¼ì§€ì¡°ì ˆ, í•­ì—¼, ê°ì§ˆì œê±°, ìˆ˜ë¶„ê³µê¸‰, ìœ ìˆ˜ë¶„ë°¸ëŸ°ìŠ¤, ë¯¸ë°±, í•­ì‚°í™”

### 4. ì¼€ì–´ ì¦ìƒ (3-6ê°œ) â­ ë§¤ìš° ì¤‘ìš”
- ì˜ˆì‹œ: ê±´ì¡°, ì¸ì„¤(ê°ì§ˆ), í™ì¡°, ê°€ë ¤ì›€, ë¾°ë£¨ì§€, í”¼ì§€ê³¼ë‹¤, ëª¨ê³µí™•ëŒ€
- ì„±ë¶„ íš¨ëŠ¥ê³¼ ì§ì ‘ ì—°ê²°ë˜ëŠ” ì¦ìƒë§Œ í¬í•¨

### 5. í•µì‹¬ ì„±ë¶„ (2-5ê°œ)
- ì „ì„±ë¶„ ì¤‘ íš¨ëŠ¥ì— ê°€ì¥ ì¤‘ìš”í•œ ì„±ë¶„ë§Œ ì„ íƒ
- ì•ìª½ì— ìœ„ì¹˜í•œ(ë†ë„ ë†’ì€) ê¸°ëŠ¥ì„± ì„±ë¶„ ìš°ì„ 

### 6. ì œí’ˆ ì„¤ëª… (2-3ë¬¸ì¥)
- ê¸ˆì§€ í‘œí˜„: ì¹˜ë£Œ, ì™„ì¹˜
- ê¶Œì¥ í‘œí˜„: ì¼€ì–´, ì™„í™”, ê°œì„ , ì§„ì •, ë„ì›€, ê´€ë¦¬, ë³´í˜¸, ì§€ì›

## ì¶œë ¥ ì˜ˆì‹œ 1: í”¼ë¶€ì¥ë²½ ì¼€ì–´ í¬ë¦¼
[ì œí’ˆìœ í˜•: í¬ë¦¼]
[í”¼ë¶€íƒ€ì…: ê±´ì„±, ë¯¼ê°ì„±]
[ê´€ë ¨ í”¼ë¶€ì§ˆí™˜: ê±´ì„ , ì•„í† í”¼]
[ì£¼ìš” íš¨ëŠ¥: ë³´ìŠµ, ì§„ì •, í”¼ë¶€ì¥ë²½ê°•í™”]
[ì¼€ì–´ ì¦ìƒ: ê±´ì¡°, ì¸ì„¤, í™ì¡°, ê°€ë ¤ì›€, í”¼ë¶€ì¥ë²½ì†ìƒ]
[í•µì‹¬ ì„±ë¶„: ì„¸ë¼ë§ˆì´ë“œ NP, ì½œë ˆìŠ¤í…Œë¡¤, íŒí…Œë†€, ì•Œë€í† ì¸]

ê±´ì„ ê³¼ ì•„í† í”¼ë¡œ ì¸í•œ ê±´ì¡°í•˜ê³  ë¯¼ê°í•œ í”¼ë¶€ì˜ ì†ìƒëœ í”¼ë¶€ ì¥ë²½ì„ ë³µì›í•˜ëŠ” ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.
ì„¸ë¼ë§ˆì´ë“œì™€ ì½œë ˆìŠ¤í…Œë¡¤ ì„±ë¶„ì´ ìˆ˜ë¶„ ì†ì‹¤ì„ ë°©ì§€í•˜ê³ , íŒí…Œë†€ê³¼ ì•Œë€í† ì¸ì´ ì¸ì„¤ê³¼ í™ì¡°ë¥¼ ì§„ì •ì‹œí‚¤ë©° ê°€ë ¤ì›€ì„ ì™„í™”í•©ë‹ˆë‹¤.
ë¬´í–¥ë£Œ ì €ìê·¹ í¬ë®¬ëŸ¬ë¡œ ì˜ˆë¯¼í•œ í”¼ë¶€ì—ë„ ì•ˆì „í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

## ì¶œë ¥ ì˜ˆì‹œ 2: ì—¬ë“œë¦„ ì¼€ì–´ í† ë„ˆ
[ì œí’ˆìœ í˜•: í† ë„ˆ]
[í”¼ë¶€íƒ€ì…: ì§€ì„±, ë³µí•©ì„±]
[ê´€ë ¨ í”¼ë¶€ì§ˆí™˜: ì—¬ë“œë¦„, ì§€ë£¨]
[ì£¼ìš” íš¨ëŠ¥: í”¼ì§€ì¡°ì ˆ, ê°ì§ˆì œê±°, í•­ì—¼, ëª¨ê³µì¼€ì–´]
[ì¼€ì–´ ì¦ìƒ: ë¾°ë£¨ì§€, í”¼ì§€ê³¼ë‹¤, ëª¨ê³µí™•ëŒ€, ê°ì§ˆ, ì—¼ì¦]
[í•µì‹¬ ì„±ë¶„: ì‚´ë¦¬ì‹¤ì‚°, ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ, ì§•í¬ PCA]

ì—¬ë“œë¦„ê³¼ ê³¼ë‹¤ í”¼ì§€ë¡œ ê³ ë¯¼í•˜ëŠ” ì§€ì„± í”¼ë¶€ì˜ ëª¨ê³µê³¼ ê°ì§ˆì„ ì¼€ì–´í•˜ëŠ” ë° ë„ì›€ì„ ì¤ë‹ˆë‹¤.
ì‚´ë¦¬ì‹¤ì‚°ì´ ëª¨ê³µ ì† ê°ì§ˆê³¼ í”¼ì§€ë¥¼ ì œê±°í•˜ê³ , ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œê°€ í”¼ì§€ ë¶„ë¹„ë¥¼ ì¡°ì ˆí•˜ë©° ì—¼ì¦ì„ ì§„ì •ì‹œí‚µë‹ˆë‹¤.
ë…¼ì½”ë©”ë„ì œë‹‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œë¡œ ëª¨ê³µ ë§‰í˜ ê±±ì • ì—†ì´ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

## ì¶œë ¥ ì˜ˆì‹œ 3: ê¸°ì´ˆ ë³´ìŠµ ë¡œì…˜
[ì œí’ˆìœ í˜•: ë¡œì…˜]
[í”¼ë¶€íƒ€ì…: ê±´ì„±, ë³µí•©ì„±]
[ê´€ë ¨ í”¼ë¶€ì§ˆí™˜: ì •ìƒí”¼ë¶€]
[ì£¼ìš” íš¨ëŠ¥: ë³´ìŠµ, ìˆ˜ë¶„ê³µê¸‰, ìœ ìˆ˜ë¶„ë°¸ëŸ°ìŠ¤]
[ì¼€ì–´ ì¦ìƒ: ê±´ì¡°, ë‹¹ê¹€, ê°ì§ˆ]
[í•µì‹¬ ì„±ë¶„: ê¸€ë¦¬ì„¸ë¦°, íˆì•Œë£¨ë¡ ì‚°, íŒí…Œë†€]

ì •ìƒ í”¼ë¶€ì˜ ì¼ìƒì ì¸ ê±´ì¡°í•¨ê³¼ ë‹¹ê¹€ì„ ì™„í™”í•˜ëŠ” ê¸°ì´ˆ ë³´ìŠµ ì œí’ˆì…ë‹ˆë‹¤.
íˆì•Œë£¨ë¡ ì‚°ê³¼ ê¸€ë¦¬ì„¸ë¦°ì´ í”¼ë¶€ì— ìˆ˜ë¶„ì„ ê³µê¸‰í•˜ê³ , íŒí…Œë†€ì´ ì´‰ì´‰í•¨ì„ ìœ ì§€ì‹œì¼œì¤ë‹ˆë‹¤.
ê°€ë³ê³  ì‚°ëœ»í•œ ì œí˜•ìœ¼ë¡œ ëˆì ì„ ì—†ì´ ë¹ ë¥´ê²Œ í¡ìˆ˜ë©ë‹ˆë‹¤.

ì´ì œ ìœ„ í˜•ì‹ì— ë§ì¶° ì •í™•í•˜ê²Œ ìƒì„±í•´ì£¼ì„¸ìš”.
"""

    def parse_claude_response(self, response_text: str) -> Dict:
        """
        Claude ì‘ë‹µì„ íŒŒì‹±í•˜ì—¬ êµ¬ì¡°í™”ëœ ë°ì´í„°ë¡œ ë³€í™˜
        
        Args:
            response_text: Claude API ì‘ë‹µ í…ìŠ¤íŠ¸
            
        Returns:
            íŒŒì‹±ëœ ë°ì´í„° ë”•ì…”ë„ˆë¦¬
        """
        try:
            # í•„ìš”í•œ 3ê°œ í•„ë“œë§Œ ì •ê·œì‹ìœ¼ë¡œ ì¶”ì¶œ
            patterns = {
                'ì œí’ˆìœ í˜•': r'\[ì œí’ˆìœ í˜•:\s*([^\]]+)\]',
                'í”¼ë¶€íƒ€ì…': r'\[í”¼ë¶€íƒ€ì…:\s*([^\]]+)\]',
                'ê´€ë ¨_í”¼ë¶€ì§ˆí™˜': r'\[ê´€ë ¨ í”¼ë¶€ì§ˆí™˜:\s*([^\]]+)\]'
            }
            
            parsed_data = {}
            
            # ê° í•„ë“œ ì¶”ì¶œ
            for field, pattern in patterns.items():
                match = re.search(pattern, response_text)
                if match:
                    # ì‰¼í‘œë¡œ ë¶„ë¦¬í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜ (ì œí’ˆìœ í˜• ì œì™¸)
                    if field == 'ì œí’ˆìœ í˜•':
                        parsed_data[field] = match.group(1).strip()
                    else:
                        items = [item.strip() for item in match.group(1).split(',')]
                        parsed_data[field] = items
                else:
                    parsed_data[field] = None
            
            # ì›ë³¸ ì‘ë‹µ í…ìŠ¤íŠ¸ ì €ì¥ (ì„ë² ë”©ìš©)
            parsed_data['ì›ë³¸_ì‘ë‹µ'] = response_text
            
            return parsed_data
            
        except Exception as e:
            print(f"ì‘ë‹µ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return {
                'ì œí’ˆìœ í˜•': None,
                'í”¼ë¶€íƒ€ì…': None,
                'ê´€ë ¨_í”¼ë¶€ì§ˆí™˜': None,
                'ì›ë³¸_ì‘ë‹µ': response_text
            }

    def call_claude_api(self, ì œí’ˆëª…: str, ë¸Œëœë“œ: str, ì œí’ˆì„¤ëª…: str, ì „ì„±ë¶„: str, max_retries: int = 3) -> Optional[Dict]:
        """
        Claude API í˜¸ì¶œ
        
        Args:
            ì œí’ˆëª…: í™”ì¥í’ˆ ì œí’ˆëª…
            ë¸Œëœë“œ: ë¸Œëœë“œëª…
            ì œí’ˆì„¤ëª…: ì œí’ˆ ì„¤ëª…
            ì „ì„±ë¶„: ì „ì„±ë¶„ ë¦¬ìŠ¤íŠ¸
            max_retries: ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜
            
        Returns:
            íŒŒì‹±ëœ ì‘ë‹µ ë°ì´í„° ë˜ëŠ” None
        """
        prompt = self.prompt_template.format(
            ì œí’ˆëª…=ì œí’ˆëª…,
            ë¸Œëœë“œ=ë¸Œëœë“œ,
            ì œí’ˆì„¤ëª…=ì œí’ˆì„¤ëª…,
            ì „ì„±ë¶„=ì „ì„±ë¶„
        )
        
        for attempt in range(max_retries):
            try:
                response = self.client.messages.create(
                    model=self.model,
                    max_tokens=1500,
                    temperature=0.3,
                    messages=[{
                        "role": "user",
                        "content": prompt
                    }]
                )
                
                response_text = response.content[0].text
                parsed_data = self.parse_claude_response(response_text)
                
                return parsed_data
                
            except Exception as e:
                print(f"API í˜¸ì¶œ ì‹¤íŒ¨ (ì‹œë„ {attempt + 1}/{max_retries}): {e}")
                if attempt < max_retries - 1:
                    time.sleep(2 ** attempt)  # ì§€ìˆ˜ ë°±ì˜¤í”„
                else:
                    print(f"ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. ì œí’ˆ: {ì œí’ˆëª…}")
                    return None

    def process_excel_file(self, 
                          excel_path: str, 
                          output_path: str = None,
                          start_row: int = 0,
                          end_row: int = None,
                          save_interval: int = 10) -> pd.DataFrame:
        """
        ì—‘ì…€ íŒŒì¼ì„ ì½ì–´ì„œ Claude APIë¡œ ì²˜ë¦¬
        
        Args:
            excel_path: ì…ë ¥ ì—‘ì…€ íŒŒì¼ ê²½ë¡œ
            output_path: ì¶œë ¥ íŒŒì¼ ê²½ë¡œ (Noneì´ë©´ ìë™ ìƒì„±)
            start_row: ì‹œì‘ í–‰ (0ë¶€í„° ì‹œì‘)
            end_row: ì¢…ë£Œ í–‰ (Noneì´ë©´ ëê¹Œì§€)
            save_interval: ì¤‘ê°„ ì €ì¥ ê°„ê²©
            
        Returns:
            ì²˜ë¦¬ëœ ë°ì´í„°í”„ë ˆì„
        """
        # ì—‘ì…€ íŒŒì¼ ì½ê¸°
        print(f"ì—‘ì…€ íŒŒì¼ ì½ëŠ” ì¤‘: {excel_path}")
        df = pd.read_excel(excel_path)
        
        # í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
        required_columns = ['ì œí’ˆëª…', 'ë¸Œëœë“œ', 'ì œí’ˆì„¤ëª…', 'ì „ì„±ë¶„']
        missing_columns = [col for col in required_columns if col not in df.columns]
        
        if missing_columns:
            print(f"í•„ìˆ˜ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤: {missing_columns}")
            print(f"í˜„ì¬ ì»¬ëŸ¼: {list(df.columns)}")
            return None
        
        # ì²˜ë¦¬í•  ë²”ìœ„ ì„¤ì •
        if end_row is None:
            end_row = len(df)
        
        df_subset = df.iloc[start_row:end_row].copy()
        print(f"ì²˜ë¦¬í•  ë°ì´í„°: {len(df_subset)}ê°œ ({start_row}í–‰ë¶€í„° {end_row-1}í–‰ê¹Œì§€)")
        
        # ì¶œë ¥ íŒŒì¼ ê²½ë¡œ ì„¤ì •
        if output_path is None:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            output_path = f"cosmetic_data_processed_{timestamp}.xlsx"
        
        # ê²°ê³¼ ì €ì¥ìš© ë¦¬ìŠ¤íŠ¸
        results = []
        
        # temp íŒŒì¼ ì¶”ì ìš© ë¦¬ìŠ¤íŠ¸
        temp_files = []
        
        # ì§„í–‰ ìƒí™© ì¶”ì 
        total_count = len(df_subset)
        success_count = 0
        error_count = 0
        
        print(f"\nì²˜ë¦¬ ì‹œì‘: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print("=" * 50)
        
        for idx, row in df_subset.iterrows():
            try:
                ì œí’ˆëª… = str(row['ì œí’ˆëª…']).strip()
                ë¸Œëœë“œ = str(row['ë¸Œëœë“œ']).strip()
                ì œí’ˆì„¤ëª… = str(row['ì œí’ˆì„¤ëª…']).strip()
                ì „ì„±ë¶„ = str(row['ì „ì„±ë¶„']).strip()
                
                # ê°€ê²© ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸ (ì—†ìœ¼ë©´ None)
                if 'ê°€ê²©' in df.columns and pd.notna(row.get('ê°€ê²©')):
                    ê°€ê²© = row['ê°€ê²©']
                else:
                    ê°€ê²© = None
                
                print(f"[{idx-start_row+1}/{total_count}] ì²˜ë¦¬ ì¤‘: {ë¸Œëœë“œ} - {ì œí’ˆëª…}")
                
                # Claude API í˜¸ì¶œ
                result = self.call_claude_api(ì œí’ˆëª…, ë¸Œëœë“œ, ì œí’ˆì„¤ëª…, ì „ì„±ë¶„)
                
                if result:
                    # ì›ë³¸ ë°ì´í„°ì™€ ê²°í•© (ìˆœì„œ: ë¸Œëœë“œ, ì œí’ˆëª…, ì œí’ˆì„¤ëª…, ì „ì„±ë¶„, ì„ë² ë”©_í…ìŠ¤íŠ¸, ì œí’ˆìœ í˜•, í”¼ë¶€íƒ€ì…, ê´€ë ¨_í”¼ë¶€ì§ˆí™˜, ê°€ê²©)
                    combined_data = {
                        'ë¸Œëœë“œ': ë¸Œëœë“œ,
                        'ì œí’ˆëª…': ì œí’ˆëª…,
                        'ì œí’ˆì„¤ëª…': ì œí’ˆì„¤ëª…,
                        'ì „ì„±ë¶„': ì „ì„±ë¶„,
                        'ì„ë² ë”©_í…ìŠ¤íŠ¸': result.get('ì›ë³¸_ì‘ë‹µ', ''),
                        'ì œí’ˆìœ í˜•': result.get('ì œí’ˆìœ í˜•'),
                        'í”¼ë¶€íƒ€ì…': result.get('í”¼ë¶€íƒ€ì…'),
                        'ê´€ë ¨_í”¼ë¶€ì§ˆí™˜': result.get('ê´€ë ¨_í”¼ë¶€ì§ˆí™˜'),
                        'ê°€ê²©': ê°€ê²©
                    }
                    results.append(combined_data)
                    success_count += 1
                    print(f"âœ… ì„±ê³µ - ì œí’ˆìœ í˜•: {result.get('ì œí’ˆìœ í˜•', 'N/A')}")
                else:
                    # ì‹¤íŒ¨í•œ ê²½ìš°ì—ë„ ì›ë³¸ ë°ì´í„°ëŠ” ë³´ì¡´
                    error_data = {
                        'ë¸Œëœë“œ': ë¸Œëœë“œ,
                        'ì œí’ˆëª…': ì œí’ˆëª…,
                        'ì œí’ˆì„¤ëª…': ì œí’ˆì„¤ëª…,
                        'ì „ì„±ë¶„': ì „ì„±ë¶„,
                        'ì„ë² ë”©_í…ìŠ¤íŠ¸': None,
                        'ì œí’ˆìœ í˜•': None,
                        'í”¼ë¶€íƒ€ì…': None,
                        'ê´€ë ¨_í”¼ë¶€ì§ˆí™˜': None,
                        'ê°€ê²©': ê°€ê²©,
                        'ì²˜ë¦¬_ìƒíƒœ': 'API_ERROR'
                    }
                    results.append(error_data)
                    error_count += 1
                    print("âŒ ì‹¤íŒ¨")
                
                # ì¤‘ê°„ ì €ì¥
                if (idx - start_row + 1) % save_interval == 0:
                    temp_df = pd.DataFrame(results)
                    temp_output = output_path.replace('.xlsx', f'_temp_{idx-start_row+1}.xlsx')
                    temp_df.to_excel(temp_output, index=False)
                    temp_files.append(temp_output)  # temp íŒŒì¼ ëª©ë¡ì— ì¶”ê°€
                    print(f"ğŸ’¾ ì¤‘ê°„ ì €ì¥: {temp_output}")
                
                # API í˜¸ì¶œ ê°„ê²© (Rate Limit ë°©ì§€)
                time.sleep(1)
                
            except Exception as e:
                print(f"âŒ í–‰ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")
                error_count += 1
                continue
        
        # ìµœì¢… ê²°ê³¼ ì €ì¥
        if results:
            final_df = pd.DataFrame(results)
            final_df.to_excel(output_path, index=False)
            
            # temp íŒŒì¼ë“¤ ì‚­ì œ
            deleted_count = 0
            for temp_file in temp_files:
                try:
                    if os.path.exists(temp_file):
                        os.remove(temp_file)
                        deleted_count += 1
                except Exception as e:
                    print(f"âš ï¸ temp íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: {temp_file} - {e}")
            
            if deleted_count > 0:
                print(f"ğŸ—‘ï¸ temp íŒŒì¼ {deleted_count}ê°œ ì‚­ì œ ì™„ë£Œ")
            
            print("\n" + "=" * 50)
            print(f"ì²˜ë¦¬ ì™„ë£Œ: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            print(f"ì´ ì²˜ë¦¬: {total_count}ê°œ")
            print(f"ì„±ê³µ: {success_count}ê°œ")
            print(f"ì‹¤íŒ¨: {error_count}ê°œ")
            print(f"ì„±ê³µë¥ : {success_count/total_count*100:.1f}%")
            print(f"ê²°ê³¼ íŒŒì¼: {output_path}")
            
            return final_df
        else:
            print("ì²˜ë¦¬ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return None

def main():
    """
    ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
    """
    # ============ ì—¬ê¸°ì— ì„¤ì •ê°’ ì…ë ¥ ============
    # API í‚¤ ì„¤ì • (í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ ì—¬ê¸°ì— ì§ì ‘ ì…ë ¥)
    api_key = os.getenv("ANTHROPIC_API_KEY", "")  # í™˜ê²½ ë³€ìˆ˜ ANTHROPIC_API_KEY ì‚¬ìš©
    
    if not api_key:
        print("ê²½ê³ : ANTHROPIC_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        print("í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ê±°ë‚˜ ì½”ë“œì—ì„œ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.")
        return
    
    # ì—‘ì…€ íŒŒì¼ ê²½ë¡œ ì„¤ì •
    excel_path = "í™”ì¥í’ˆë°ì´í„°.xlsx"  # ì—¬ê¸°ì— ì—‘ì…€ íŒŒì¼ ê²½ë¡œ ì…ë ¥
    
    # ì²˜ë¦¬ ë²”ìœ„ ì„¤ì •
    start_row = 0      # ì‹œì‘ í–‰ (0ë¶€í„° ì‹œì‘)
    end_row = 200      # ì¢…ë£Œ í–‰ (Noneì´ë©´ ì „ì²´, ìˆ«ì ì…ë ¥í•˜ë©´ í•´ë‹¹ í–‰ê¹Œì§€)
    # ==========================================
    
    if not os.path.exists(excel_path):
        print(f"íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: {excel_path}")
        return
    
    # ë°ì´í„° ìƒì„±ê¸° ì´ˆê¸°í™”
    generator = CosmeticDataGenerator(api_key)
    
    # ì²˜ë¦¬ ì‹¤í–‰
    try:
        result_df = generator.process_excel_file(
            excel_path=excel_path,
            start_row=start_row,
            end_row=end_row,
            save_interval=10
        )
        
        if result_df is not None:
            print(f"\nì²˜ë¦¬ ì™„ë£Œ! ê²°ê³¼ ë°ì´í„° í˜•íƒœ:")
            print(result_df.head())
            
    except KeyboardInterrupt:
        print("\nì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
    except Exception as e:
        print(f"ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

if __name__ == "__main__":
    main()
